#!/bin/bash

# Ubuntu System Update Script
# This script updates the Ubuntu system using various package managers
# Usage: sudo upall [--verbose|-v]

# Set script variables
SCRIPT_DIR="/opt/update-all"
LOG_FILE="$SCRIPT_DIR/update_log.txt"
ERROR_COUNT=0
TOTAL_COMMANDS=8
VERBOSE=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Function to parse command line arguments
parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -h|--help)
                echo "Usage: sudo upall [--verbose|-v]"
                echo ""
                echo "Options:"
                echo "  -v, --verbose    Show detailed output on terminal as well as in log file"
                echo "  -h, --help       Show this help message"
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                echo "Use -h or --help for usage information"
                exit 1
                ;;
        esac
    done
}

# Function to log command output
log_command() {
    local command=$1
    local description=$2

    print_status $BLUE "Running: $description"
    echo "===========================================" >> "$LOG_FILE"
    echo "Command: $command" >> "$LOG_FILE"
    echo "Timestamp: $(date)" >> "$LOG_FILE"
    echo "===========================================" >> "$LOG_FILE"

    # Run command and capture both stdout and stderr
    if [[ "$VERBOSE" == "true" ]]; then
        # In verbose mode, show output on terminal and log to file
        if eval "$command" 2>&1 | tee -a "$LOG_FILE"; then
            print_status $GREEN "✓ Success: $description"
            echo "Status: SUCCESS" >> "$LOG_FILE"
        else
            print_status $RED "✗ Failed: $description"
            echo "Status: FAILED" >> "$LOG_FILE"
            ((ERROR_COUNT++))
        fi
    else
        # Normal mode, only log to file
        if eval "$command" >> "$LOG_FILE" 2>&1; then
            print_status $GREEN "✓ Success: $description"
            echo "Status: SUCCESS" >> "$LOG_FILE"
        else
            print_status $RED "✗ Failed: $description"
            echo "Status: FAILED" >> "$LOG_FILE"
            ((ERROR_COUNT++))
        fi
    fi

    echo "" >> "$LOG_FILE"
}

# Function to check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_status $RED "This script must be run as root (use sudo)"
        exit 1
    fi
}

# Function to ensure update-git-repos is available
ensure_update_git_repos() {
    # Check if update-git-repos is already in PATH
    if command -v update-git-repos &> /dev/null; then
        return 0
    fi

    print_status $YELLOW "⚠ update-git-repos not found, installing..."

    # Check if git is installed
    if ! command -v git &> /dev/null; then
        print_status $RED "✗ Git is not installed. Cannot clone update-git-repos repository."
        print_status $YELLOW "⚠ Skipping update-git-repos installation"
        return 1
    fi

    # Get the actual user (not root)
    local actual_user="${SUDO_USER:-$USER}"
    local repo_dir="/opt/update-git-repos"
    local script_path="$repo_dir/src/update_repos.py"
    local symlink_path="/usr/bin/update-git-repos"

    # Clone the repository
    if [ -d "$repo_dir" ]; then
        print_status $YELLOW "⚠ Directory $repo_dir already exists, removing it first..."
        rm -rf "$repo_dir"
    fi

    print_status $BLUE "Cloning update-git-repos repository..."
    if git clone https://github.com/s0m3OnE47/update-git-repos "$repo_dir" >> "$LOG_FILE" 2>&1; then
        print_status $GREEN "✓ Repository cloned successfully"
    else
        print_status $RED "✗ Failed to clone repository"
        return 1
    fi

    # Make the script executable
    if chmod +x "$script_path" >> "$LOG_FILE" 2>&1; then
        print_status $GREEN "✓ Made script executable"
    else
        print_status $RED "✗ Failed to make script executable"
        return 1
    fi

    # Set ownership to the actual user
    if chown -R "$actual_user:$actual_user" "$repo_dir" >> "$LOG_FILE" 2>&1; then
        print_status $GREEN "✓ Set ownership to $actual_user"
    else
        print_status $YELLOW "⚠ Failed to set ownership (non-critical)"
    fi

    # Create symlink
    if ln -sf "$script_path" "$symlink_path" >> "$LOG_FILE" 2>&1; then
        print_status $GREEN "✓ Created symlink at $symlink_path"
    else
        print_status $RED "✗ Failed to create symlink"
        return 1
    fi

    print_status $GREEN "✓ update-git-repos installed successfully"
    return 0
}

# Function to create log file header
create_log_header() {
    echo "===========================================" > "$LOG_FILE"
    echo "Ubuntu System Update Log" >> "$LOG_FILE"
    echo "Started: $(date)" >> "$LOG_FILE"
    echo "===========================================" >> "$LOG_FILE"
    echo "" >> "$LOG_FILE"
}

# Function to display final summary
display_summary() {
    echo ""
    print_status $BLUE "==========================================="
    print_status $BLUE "UPDATE SUMMARY"
    print_status $BLUE "==========================================="

    if [[ $ERROR_COUNT -eq 0 ]]; then
        print_status $GREEN "✓ All updates completed successfully!"
        print_status $GREEN "✓ $TOTAL_COMMANDS/$TOTAL_COMMANDS commands executed without errors"
    else
        print_status $RED "✗ $ERROR_COUNT out of $TOTAL_COMMANDS commands failed"
        print_status $YELLOW "Check the log file for details: $LOG_FILE"
    fi

    if [[ "$VERBOSE" == "true" ]]; then
        print_status $BLUE "Verbose mode: Output displayed on terminal and saved to: $LOG_FILE"
    else
        print_status $BLUE "Verbose output saved to: $LOG_FILE"
    fi
    print_status $BLUE "Completed: $(date)"
    print_status $BLUE "==========================================="
}

# Main execution
main() {
    # Parse command line arguments
    parse_arguments "$@"

    # Check if running as root
    check_root

    # Clear screen and show header
    clear
    print_status $BLUE "==========================================="
    print_status $BLUE "Ubuntu System Update Script"
    print_status $BLUE "==========================================="
    print_status $YELLOW "Starting system update at $(date)"
    print_status $BLUE "==========================================="

    # Create log file header
    create_log_header

    # Ensure update-git-repos is available
    ensure_update_git_repos

    # Update package lists
    log_command "apt update -y" "Update package lists"

    # Upgrade installed packages
    log_command "apt upgrade -y" "Upgrade installed packages"

    # Remove unnecessary packages
    log_command "apt autoremove -y" "Remove unnecessary packages"

    # Update snap packages
    log_command "snap refresh" "Update snap packages"

    # Update Cursor (if available)
    log_command "update-cursor --no-progress-bar" "Update Cursor editor"

    # Additional Ubuntu update commands
    log_command "apt full-upgrade -y" "Full system upgrade (handles dependencies)"
    log_command "apt autoclean" "Clean package cache"

    # Update Flatpak packages (if available)
    if command -v flatpak &> /dev/null; then
        log_command "flatpak update -y" "Update Flatpak packages"
    else
        print_status $YELLOW "⚠ Flatpak not installed, skipping Flatpak updates"
    fi

    # Update git repositories (if available)
    if command -v update-git-repos &> /dev/null; then
        local actual_user="${SUDO_USER:-$USER}"
        if [[ "$actual_user" != "root" ]] && id "$actual_user" &>/dev/null; then
            log_command "sudo -u $actual_user update-git-repos" "Update git repositories"
        else
            log_command "update-git-repos" "Update git repositories"
        fi
    else
        print_status $YELLOW "⚠ update-git-repos not available, skipping git repository updates"
    fi

    # Check if reboot is required
    if [ -f /var/run/reboot-required ]; then
        print_status $YELLOW "⚠ System reboot is required after updates"
        echo "Reboot required: YES" >> "$LOG_FILE"
    else
        print_status $GREEN "✓ No reboot required"
        echo "Reboot required: NO" >> "$LOG_FILE"
    fi

    # Display final summary
    display_summary

    # # Summarize the update log with Ollama (if installed)
    # if ollama --version >/dev/null 2>&1; then
    #     cat /opt/update-all/update_log.txt | ollama run gpt-oss:20b "You are given an update log for the System update & upgrade script. Using only this log, summarize the changes to system in a concise list: Important packages that were updated, which were removed, snap packages updated, cursor version updated from and to, flatpack update, miscellaneous changes. The output is displayed on the terminal, hence avoid using markdown formatting."
    # else
    #     print_status $YELLOW "⚠ Ollama not installed, skipping summary"
    # fi

    # Exit with appropriate code
    if [[ $ERROR_COUNT -eq 0 ]]; then
        exit 0
    else
        exit 1
    fi
}

# Run main function
main "$@"
